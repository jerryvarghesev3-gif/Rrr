pp



private const val DOS_TAR_GZ_FILE_NAME = "firmware_imx6_d.tar.gz.enc"

fun DextractYoctoVersion(targzFile: File): Outcome<String> {

    // Don't block based on filename.
    // Just try to find the "hillrom-version" inside the tar.gz.enc
    return when (val hillromVersion = searchTarGzFile(targzFile, "hillrom-version")) {

        is Outcome.Ok -> {
            val lines = hillromVersion.value.decodeToString()
                .split('\n')
                .map { it.trim() }

            for (line in lines) {
                if (line.contains("Version:", ignoreCase = true)) {
                    val regex = Regex("\\d+(\\.\\d+)+")
                    val match = regex.find(line)?.value
                    return if (match != null) {
                        ProLog.i(MODULE_NAME, "${targzFile.name} OS version = $match")
                        Outcome.Ok(match)
                    } else {
                        ProLog.e(MODULE_NAME, "Failed to decode OS version from hillrom-version.")
                        Outcome.Error("Failed to decode OS version.")
                    }
                }
            }

            ProLog.e(MODULE_NAME, "hillrom-version found but no Version line.")
            Outcome.Error("No Version line in hillrom-version.")
        }

        is Outcome.Error -> {
            Outcome.Error(hillromVersion.error as String)
        }
    }
}
