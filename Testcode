package com.connect.connection

import android.Manifest
import android.content.ContentValues
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Build
import android.os.Bundle
import android.provider.MediaStore
import android.view.View
import android.widget.TextView
import android.widget.Toast
import androidx.activity.result.contract.ActivityResultContracts
import androidx.appcompat.app.AppCompatActivity
import androidx.camera.core.*
import androidx.camera.lifecycle.ProcessCameraProvider
import androidx.camera.view.PreviewView
import androidx.core.content.ContextCompat
import androidx.core.content.FileProvider
import com.google.mlkit.vision.barcode.Barcode
import com.google.mlkit.vision.barcode.BarcodeScannerOptions
import com.google.mlkit.vision.barcode.BarcodeScanning
import com.google.mlkit.vision.common.InputImage
import java.io.File
import java.util.concurrent.ExecutorService
import java.util.concurrent.Executors
import java.util.concurrent.atomic.AtomicBoolean

class QRActivity : AppCompatActivity() {

    companion object {
        const val EXTRA_BED = "bedId"
        const val EXTRA_IMAGE_URI = "imageUri"
    }

    private lateinit var previewView: PreviewView
    private lateinit var txtInfo: TextView

    private lateinit var cameraExecutor: ExecutorService
    private var imageCapture: ImageCapture? = null

    private val decoding = AtomicBoolean(false)
    private var lastDecoded: String? = null

    // Permission launcher
    private val requestCameraPerm =
        registerForActivityResult(ActivityResultContracts.RequestPermission()) { granted ->
            if (granted) startCamera() else {
                Toast.makeText(this, "Camera permission required", Toast.LENGTH_LONG).show()
                finish()
            }
        }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_qra)

        previewView = findViewById(R.id.previewViewA)
        txtInfo = findViewById(R.id.txtInfoA)

        cameraExecutor = Executors.newSingleThreadExecutor()

        // Ask or start
        if (ContextCompat.checkSelfPermission(this, Manifest.permission.CAMERA)
            == PackageManager.PERMISSION_GRANTED
        ) startCamera() else requestCameraPerm.launch(Manifest.permission.CAMERA)
    }

    override fun onDestroy() {
        super.onDestroy()
        try { cameraExecutor.shutdown() } catch (_: Exception) {}
    }

    // --- CameraX setup and ML Kit analyzer ---
    @OptIn(ExperimentalGetImage::class)
    private fun startCamera() {
        val providerFuture = ProcessCameraProvider.getInstance(this)
        providerFuture.addListener({
            val provider = providerFuture.get()

            val preview = Preview.Builder().build().also {
                it.setSurfaceProvider(previewView.surfaceProvider)
            }

            imageCapture = ImageCapture.Builder()
                .setCaptureMode(ImageCapture.CAPTURE_MODE_MINIMIZE_LATENCY)
                .build()

            val analysis = ImageAnalysis.Builder()
                .setBackpressureStrategy(ImageAnalysis.STRATEGY_KEEP_ONLY_LATEST)
                .build()

            val opts = BarcodeScannerOptions.Builder()
                .setBarcodeFormats(Barcode.FORMAT_QR_CODE) // QR only
                .build()
            val scanner = BarcodeScanning.getClient(opts)

            analysis.setAnalyzer(cameraExecutor) { proxy ->
                try {
                    val media = proxy.image ?: run { proxy.close(); return@setAnalyzer }
                    if (decoding.get()) { proxy.close(); return@setAnalyzer }
                    val image = InputImage.fromMediaImage(
                        media, proxy.imageInfo.rotationDegrees
                    )
                    decoding.set(true)
                    scanner.process(image)
                        .addOnSuccessListener { codes ->
                            val value = codes.firstOrNull()?.rawValue
                            if (!value.isNullOrBlank()) {
                                lastDecoded = value.trim()
                                runOnUiThread {
                                    txtInfo.text = "Scanned: $lastDecoded"
                                }
                                // Snap one still image then open Summary
                                takePhotoAndOpenSummary()
                            } else decoding.set(false)
                        }
                        .addOnFailureListener { decoding.set(false) }
                        .addOnCompleteListener { proxy.close() }
                } catch (_: Throwable) {
                    proxy.close(); decoding.set(false)
                }
            }

            try {
                provider.unbindAll()
                provider.bindToLifecycle(
                    this,
                    CameraSelector.DEFAULT_BACK_CAMERA,
                    preview,
                    imageCapture,
                    analysis
                )
                txtInfo.text = "Aim at Bed ID QR"
                previewView.visibility = View.VISIBLE
            } catch (t: Throwable) {
                Toast.makeText(this, "Camera start failed", Toast.LENGTH_LONG).show()
                finish()
            }
        }, ContextCompat.getMainExecutor(this))
    }

    private fun takePhotoAndOpenSummary() {
        val cap = imageCapture ?: return openSummary(null)
        val name = "qra_${System.currentTimeMillis()}.jpg"

        // Q: save to Pictures or cache?  Use MediaStore on Q+; fallback to cache + FileProvider.
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
            val values = ContentValues().apply {
                put(MediaStore.MediaColumns.DISPLAY_NAME, name)
                put(MediaStore.MediaColumns.MIME_TYPE, "image/jpeg")
                put(MediaStore.Images.Media.RELATIVE_PATH, "DCIM/Camera")
            }
            val opts = ImageCapture.OutputFileOptions
                .Builder(contentResolver, MediaStore.Images.Media.EXTERNAL_CONTENT_URI, values)
                .build()
            cap.takePicture(
                opts,
                ContextCompat.getMainExecutor(this),
                object : ImageCapture.OnImageSavedCallback {
                    override fun onImageSaved(output: ImageCapture.OutputFileResults) {
                        openSummary(output.savedUri)
                    }
                    override fun onError(exc: ImageCaptureException) { openSummary(null) }
                }
            )
        } else {
            val dir = File(cacheDir, "images").apply { mkdirs() }
            val photo = File(dir, name)
            val uri = FileProvider.getUriForFile(
                this, "${packageName}.fileprovider", photo
            )
            val opts = ImageCapture.OutputFileOptions.Builder(photo).build()
            cap.takePicture(
                opts,
                ContextCompat.getMainExecutor(this),
                object : ImageCapture.OnImageSavedCallback {
                    override fun onImageSaved(output: ImageCapture.OutputFileResults) {
                        openSummary(uri)
                    }
                    override fun onError(exc: ImageCaptureException) { openSummary(null) }
                }
            )
        }
    }

    private fun openSummary(photoUri: Uri?) {
        val bed = lastDecoded ?: run {
            decoding.set(false)
            Toast.makeText(this, "Scan a QR first", Toast.LENGTH_SHORT).show()
            return
        }
        val i = Intent(this, SummaryAActivity::class.java).apply {
            putExtra(EXTRA_BED, bed)
            photoUri?.let { putExtra(EXTRA_IMAGE_URI, it.toString()) }
        }
        startActivity(i)
        // IMPORTANT: let this activity live so Rescan can just back()
        decoding.set(false)
    }
}








<?xml version="1.0" encoding="utf-8"?>
<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent">

    <androidx.camera.view.PreviewView
        android:id="@+id/previewViewA"
        android:layout_width="match_parent"
        android:layout_height="match_parent" />

    <TextView
        android:id="@+id/txtInfoA"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_gravity="bottom"
        android:padding="16dp"
        android:text="Aim at Bed ID QR"
        android:textColor="#FFFFFF"
        android:background="#80000000"
        android:textSize="16sp"/>
</FrameLayout>







package com.connect.connection

import android.content.Intent
import android.net.Uri
import android.os.Bundle
import android.widget.Button
import android.widget.ImageView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity

class SummaryAActivity : AppCompatActivity() {

    private lateinit var txtBed: TextView
    private lateinit var imgPreview: ImageView
    private lateinit var btnRescan: Button
    private lateinit var btnCancel: Button
    private lateinit var btnContinue: Button

    private var bedId: String = ""
    private var imageUri: Uri? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_summary_a)

        txtBed = findViewById(R.id.txtBedA)
        imgPreview = findViewById(R.id.imgPreviewA)
        btnRescan = findViewById(R.id.btnRescanA)
        btnCancel = findViewById(R.id.btnCancelA)
        btnContinue = findViewById(R.id.btnContinueA)

        bedId = intent.getStringExtra(QRActivity.EXTRA_BED).orEmpty()
        intent.getStringExtra(QRActivity.EXTRA_IMAGE_URI)?.let { imageUri = Uri.parse(it) }

        txtBed.text = "Bed ID: $bedId"
        imageUri?.let { imgPreview.setImageURI(it) }

        btnRescan.setOnClickListener { finish() } // return to AActivity; camera still ready
        btnCancel.setOnClickListener { finish() } // or finishAffinity() if you want to exit flow

        btnContinue.setOnClickListener {
            // Hand off to B scanner; carry the Bed + photo
            val i = Intent(this, QRBActivity::class.java).apply {
                putExtra(QRActivity.EXTRA_BED, bedId)
                imageUri?.let { putExtra(QRActivity.EXTRA_IMAGE_URI, it.toString()) }
            }
            startActivity(i)
        }
    }
}






<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:padding="16dp"
    android:orientation="vertical"
    android:background="#101418">

    <ImageView
        android:id="@+id/imgPreviewA"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"
        android:scaleType="centerCrop"
        android:contentDescription="QR frame" />

    <TextView
        android:id="@+id/txtBedA"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Bed ID:"
        android:textColor="#FFFFFF"
        android:textSize="18sp"
        android:paddingTop="12dp"
        android:paddingBottom="12dp" />

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="vertical"
        android:paddingTop="8dp">

        <Button
            android:id="@+id/btnRescanA"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="RESCAN" />

        <Button
            android:id="@+id/btnContinueA"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="CONTINUE"
            android:layout_marginTop="10dp" />

        <Button
            android:id="@+id/btnCancelA"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="CANCEL"
            android:layout_marginTop="10dp" />
    </LinearLayout>
</LinearLayout>







<application
    ...>
    <!-- For pre-Q photo FileProvider fallback -->
    <provider
        android:name="androidx.core.content.FileProvider"
        android:authorities="${applicationId}.fileprovider"
        android:exported="false"
        android:grantUriPermissions="true">
        <meta-data
            android:name="android.support.FILE_PROVIDER_PATHS"
            android:resource="@xml/file_paths" />
    </provider>
</application>

<uses-permission android:name="android.permission.CAMERA"/>









