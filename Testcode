pp



private fun load() {
    launch {
        kotlin.runCatching {

            if (!connectionBloc.isConnected()) {
                updateState { state ->
                    state.copy(loadingStatus = LoadingStatus.Connecting)
                }

                if (connectionBloc.connect(G_Address._DIAG) is Outcome.Error) {
                    updateState { state ->
                        state.copy(loadingStatus = LoadingStatus.Error)
                    }

                    // ✅ 1) SHOW POPUP FIRST
                    showWrongProductPopup()

                    // ✅ 2) THEN DISCONNECT
                    connectionBloc.disconnect()

                    return@launch
                }
            }

            deviceBloc.startBoardCollection()
            loadProperties()
            deviceBloc.startBedStatusPoll()

        }.onFailure {
            // ✅ SAME ORDER HERE ALSO
            showWrongProductPopup()
            connectionBloc.disconnect()
        }
    }
}





private fun showWrongProductPopup() {
    updateState { state ->
        state.copy(
            incompatibleProductDialogVisible = true,
            incompatibleProductMessage = "Wrong product. Please use the correct application."
        )
    }
}










private fun load() {
    launch {
        kotlin.runCatching {

            if (!connectionBloc.isConnected()) {
                updateState { it.copy(loadingStatus = LoadingStatus.Connecting) }

                if (connectionBloc.connect(G_Address._DIAG) is Outcome.Error) {
                    updateState { it.copy(loadingStatus = LoadingStatus.Error) }
                    showWrongProductPopup()
                    connectionBloc.disconnect()
                    return@launch
                }
            }

            // ✅ MINIMUM: read ONE identifier from device
            // Replace this line with your real call / value:
            val productStr: String = deviceBloc.getProductString() // e.g. "CEN" or "DEN"

            val actualDevice = when {
                productStr.contains("CEN", true) -> MedDevices.CEN
                productStr.contains("DEN", true) -> MedDevices.DEN
                else -> null
            }

            // ✅ Restrict here
            if (actualDevice == null || actualDevice != currentDevice) {
                showWrongProductPopup()        // show first
                connectionBloc.disconnect()    // disconnect after
                return@launch
            }

            deviceBloc.startBoardCollection()
            loadProperties()
            deviceBloc.startBedStatusPoll()

        }.onFailure {
            showWrongProductPopup()
            connectionBloc.disconnect()
        }
    }
}

