void Firmware::onBoardUpgraded(FirmwareUpdateCAN* fw, quint32 address, bool success)
{
    if (address == GN2A_SOM && success && m_sendDecryptAfterSOMApp)
    {
        m_sendDecryptAfterSOMApp = false;

        // delete completed uploader (SOMApp)
        if (fw != nullptr) {
            delete fw;
            fw = nullptr;
        }

        // Start decrypt on next event loop tick (prevents overlap / premature switch)
        QMetaObject::invokeMethod(this, [this, address]() {

            FirmwareUpdateCAN* fw1 = new FirmwareUpdateCAN();
            fw1->setImageData(m_decryptPath);
            fw1->onChangedSelectedServer(m_decryptAddressForUpdate, m_decryptServerBoard, NULL);
            fw1->setDestination(GN2A_SOM);

            MEM_SendImageFileNameRequest req1 = MEM_SendImageFileNameRequest_init_zero;
            MEM_SendImageFileNameResponse rsp1 = MEM_SendImageFileNameResponse_init_zero;
            req1.memoryType = m_decryptMemType;

            memset(req1.imageName, 0, sizeof(req1.imageName));
            QByteArray dn("decrypt");
            int copyLen = std::min((int)sizeof(req1.imageName) - 1, (int)dn.size());
            memcpy(req1.imageName, dn.constData(), copyLen);
            req1.imageName[copyLen] = '\0';

            if (CMD_OK != MEM_SendImageFileName(GN2A_SOM, &req1, &rsp1))
            {
                updateComplete[address] = true;
                updateSuccessful[address] = false;
                delete fw1;
                return;
            }

            connect(fw1, &FirmwareUpdateCAN::imageUploadCompleted, this, &Firmware::onBoardUpgraded);
            connect(fw1, &FirmwareUpdateCAN::errorNotification, this, &Firmware::onObservedError);
            connect(fw1, &FirmwareUpdateCAN::infoNotification, this, &Firmware::onObservedInfo);
            connect(fw1, &FirmwareUpdateCAN::progressObserved, this, &Firmware::onObservedProgress);
            connect(fw1, &FirmwareUpdateCAN::newProgressPhaseStarted, this, &Firmware::onPhaseChanged);
            connect(this, &Firmware::abortUpgrade, fw1, &FirmwareUpdateCAN::abortUpgrade, Qt::DirectConnection);

            fw1->startUpdate(m_decryptMemType, false);

        }, Qt::QueuedConnection);

        return;
    }

    if (address != 0xFF)
    {
        updateComplete[address] = true;
        updateSuccessful[address] = success;
    }

    if (fw != nullptr)
        delete fw;
}
