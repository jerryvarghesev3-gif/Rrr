ll



private fun handleSetLocationResponse(json: String) {
    try {
        val obj = JSONObject(json)
        val tx   = obj.optInt("transaction_id", -1)
        if (tx != lastTxnSetLoc) return

        val status = obj.optInt("status", -1)
        when (status) {
            0 -> {
                val loc = obj.optJSONObject("data")
                    ?.optJSONObject("location")
                    ?.optString("id") ?: locationId
                setStatus("Location set OK → $loc")
                // Continue to SummaryActivity
                val intent = Intent(this, SummaryActivity::class.java).apply {
                    putExtra("gatewayId", gatewayId)
                    putExtra("bedId", bedId)
                    putExtra("locationId", locationId)
                    putExtra("status", 0)
                }
                startActivity(intent)
                finish()
            }
            99 -> {
                // Gateway says override required → retry with force=true
                ui { txtInfo.text = "Override required, retrying…" }
                sendSetLocation(force = true)
            }
            else -> setStatus("set_location failed (status=$status)")
        }
    } catch (t: Throwable) {
        setStatus("Set_location parse error: ${t.message}")
    }
}
