package com.connect.connection

import android.net.Uri
import android.os.Bundle
import android.view.View
import android.widget.Button
import android.widget.ImageView
import android.widget.ProgressBar
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.view.isVisible
import kotlinx.coroutines.*

class SummaryBActivity : AppCompatActivity() {

    // ---- Keys (kept here so you don't need any extras) ----
    companion object {
        const val EXTRA_GATEWAY   = "gatewayId"
        const val EXTRA_BED       = "bedId"
        const val EXTRA_LOCATION  = "locationId"
        const val EXTRA_IMAGE_URI = "imageUri"
    }

    // ---- UI ----
    private lateinit var txtGateway : TextView
    private lateinit var txtBed     : TextView
    private lateinit var txtLocation: TextView
    private lateinit var txtInfo    : TextView
    private lateinit var imgPreview : ImageView
    private lateinit var btnBack    : Button
    private lateinit var btnNext    : Button
    private lateinit var progress   : ProgressBar

    // ---- Data coming from A/summary-A ----
    private var gatewayId  = ""
    private var bedId      = ""
    private var locationId = ""
    private var imageUri   : Uri? = null

    // coroutine
    private val job = SupervisorJob()
    private val ui  = CoroutineScope(Dispatchers.Main + job)

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_summary_b)

        // bind
        txtGateway  = findViewById(R.id.txtGatewayB)
        txtBed      = findViewById(R.id.txtBedB)
        txtLocation = findViewById(R.id.txtLocationB)
        txtInfo     = findViewById(R.id.txtInfoB)
        imgPreview  = findViewById(R.id.imgPreviewB)
        btnBack     = findViewById(R.id.btnBackB)
        btnNext     = findViewById(R.id.btnNextB)
        progress    = findViewById(R.id.progressB)

        // read extras
        gatewayId  = intent.getStringExtra(EXTRA_GATEWAY).orEmpty()
        bedId      = intent.getStringExtra(EXTRA_BED).orEmpty()
        locationId = intent.getStringExtra(EXTRA_LOCATION).orEmpty()
        intent.getStringExtra(EXTRA_IMAGE_URI)?.let { imageUri = Uri.parse(it) }

        // show
        txtGateway.text  = "Gateway: $gatewayId"
        txtBed.text      = "Bed ID: $bedId"
        txtLocation.text = "Location ID: $locationId"
        imageUri?.let { imgPreview.setImageURI(it) }

        btnBack.setOnClickListener { finish() }

        btnNext.setOnClickListener {
            if (gatewayId.isEmpty() || bedId.isEmpty() || locationId.isEmpty()) {
                Toast.makeText(this, "Missing IDs", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            simulateSetLocationAndGo()
        }
    }

    private fun simulateSetLocationAndGo() {
        // UI state
        progress.isVisible = true
        btnNext.isEnabled = false
        txtInfo.text = "Setting location…"

        // Simulate a network/device request
        ui.launch {
            try {
                // pretend we’re sending a command & waiting for a reply
                delay(1200L)

                // flip this to false to simulate a failure:
                val success = true

                val status = if (success) 0 else -1

                // navigate to the final SummaryActivity
                SummaryActivity.start(
                    activity = this@SummaryBActivity,
                    status = status,
                    gatewayId = gatewayId,
                    bedId = bedId,
                    locationId = locationId
                )
                finish()

            } catch (t: Throwable) {
                txtInfo.text = "Error: ${t.message}"
                btnNext.isEnabled = true
                progress.visibility = View.GONE
            }
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        job.cancel()
    }
}




<?xml version="1.0" encoding="utf-8"?>
<androidx.constraintlayout.widget.ConstraintLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:id="@+id/rootB"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:padding="16dp">

    <ImageView
        android:id="@+id/imgPreviewB"
        android:layout_width="0dp"
        android:layout_height="180dp"
        android:scaleType="centerCrop"
        android:background="#EEE"
        app:layout_constraintTop_toTopOf="parent"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toEndOf="parent" />

    <TextView
        android:id="@+id/txtGatewayB"
        android:layout_width="0dp"
        android:layout_height="wrap_content"
        android:text="Gateway:"
        android:textSize="16sp"
        android:textStyle="bold"
        app:layout_constraintTop_toBottomOf="@id/imgPreviewB"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toEndOf="parent"
        android:layout_marginTop="16dp"/>

    <TextView
        android:id="@+id/txtBedB"
        android:layout_width="0dp"
        android:layout_height="wrap_content"
        android:text="Bed ID:"
        android:textSize="16sp"
        app:layout_constraintTop_toBottomOf="@id/txtGatewayB"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toEndOf="parent"
        android:layout_marginTop="8dp"/>

    <TextView
        android:id="@+id/txtLocationB"
        android:layout_width="0dp"
        android:layout_height="wrap_content"
        android:text="Location ID:"
        android:textSize="16sp"
        app:layout_constraintTop_toBottomOf="@id/txtBedB"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toEndOf="parent"
        android:layout_marginTop="8dp"/>

    <TextView
        android:id="@+id/txtInfoB"
        android:layout_width="0dp"
        android:layout_height="wrap_content"
        android:text=""
        android:textSize="14sp"
        android:textColor="#555555"
        app:layout_constraintTop_toBottomOf="@id/txtLocationB"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toEndOf="parent"
        android:layout_marginTop="12dp"/>

    <ProgressBar
        android:id="@+id/progressB"
        style="?android:attr/progressBarStyleLarge"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:visibility="gone"
        app:layout_constraintTop_toBottomOf="@id/txtInfoB"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toEndOf="parent"
        android:layout_marginTop="16dp"/>

    <Button
        android:id="@+id/btnBackB"
        android:layout_width="0dp"
        android:layout_height="48dp"
        android:text="BACK"
        app:layout_constraintTop_toBottomOf="@id/progressB"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toStartOf="@+id/btnNextB"
        app:layout_constraintHorizontalWeight="1"
        android:layout_marginTop="24dp"
        android:layout_marginEnd="8dp"/>

    <Button
        android:id="@+id/btnNextB"
        android:layout_width="0dp"
        android:layout_height="48dp"
        android:text="NEXT"
        app:layout_constraintTop_toBottomOf="@id/progressB"
        app:layout_constraintStart_toEndOf="@id/btnBackB"
        app:layout_constraintEnd_toEndOf="parent"
        app:layout_constraintHorizontalWeight="1"
        android:layout_marginTop="24dp"
        android:layout_marginStart="8dp"/>

</androidx.constraintlayout.widget.ConstraintLayout>





package com.connect.connection

import android.content.Context
import android.content.Intent
import android.os.Bundle
import android.widget.Button
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity

class SummaryActivity : AppCompatActivity() {

    companion object {
        fun start(
            activity: Context,
            status: Int,
            gatewayId: String,
            bedId: String,
            locationId: String
        ) {
            val i = Intent(activity, SummaryActivity::class.java).apply {
                putExtra("status", status)
                putExtra("gatewayId", gatewayId)
                putExtra("bedId", bedId)
                putExtra("locationId", locationId)
            }
            activity.startActivity(i)
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_summary)

        val status     = intent.getIntExtra("status", -1)
        val gatewayId  = intent.getStringExtra("gatewayId") ?: ""
        val bedId      = intent.getStringExtra("bedId") ?: ""
        val locationId = intent.getStringExtra("locationId") ?: ""

        val txt = findViewById<TextView>(R.id.summaryText)
        txt.text = buildString {
            appendLine(if (status == 0) "✅ Location set OK" else "❌ set_location failed (status=$status)")
            appendLine("Gateway: $gatewayId")
            appendLine("Bed ID: $bedId")
            appendLine("Location ID: $locationId")
        }

        findViewById<Button>(R.id.btnDone).setOnClickListener {
            // Exit the app entirely
            finishAffinity()
            finishAndRemoveTask()
        }
    }
}





<?xml version="1.0" encoding="utf-8"?>
<androidx.constraintlayout.widget.ConstraintLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:id="@+id/rootSummary"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:padding="20dp">

    <TextView
        android:id="@+id/summaryText"
        android:layout_width="0dp"
        android:layout_height="0dp"
        android:textSize="18sp"
        android:lineSpacingExtra="4dp"
        app:layout_constraintTop_toTopOf="parent"
        app:layout_constraintBottom_toTopOf="@id/btnDone"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toEndOf="parent"/>

    <Button
        android:id="@+id/btnDone"
        android:layout_width="0dp"
        android:layout_height="52dp"
        android:text="DONE"
        app:layout_constraintBottom_toBottomOf="parent"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toEndOf="parent"/>
</androidx.constraintlayout.widget.ConstraintLayout>





