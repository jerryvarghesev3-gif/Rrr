ll


lateinit var imageCapture: ImageCapture

private fun startCamera() {
    val cameraProviderFuture = ProcessCameraProvider.getInstance(this)
    cameraProviderFuture.addListener({
        val cameraProvider = cameraProviderFuture.get()

        val preview = Preview.Builder().build().also {
            it.setSurfaceProvider(previewView.surfaceProvider)
        }

        // You already have ImageAnalysis for the QR detector. Keep it.
        val analysis = ImageAnalysis.Builder().build().apply {
            setAnalyzer(cameraExecutor) { imageProxy ->
                // run your QR detector...
                // if QR found -> onQrDetected(decodedText)
            }
        }

        imageCapture = ImageCapture.Builder()
            .setCaptureMode(ImageCapture.CAPTURE_MODE_MINIMIZE_LATENCY)
            .build()

        val selector = CameraSelector.DEFAULT_BACK_CAMERA
        cameraProvider.unbindAll()
        cameraProvider.bindToLifecycle(this, selector, preview, analysis, imageCapture)
    }, ContextCompat.getMainExecutor(this))
}




private fun onQrDetected(decoded: String) {
    // Take a still image of what the user is seeing right now
    val imagesDir = File(cacheDir, "images").apply { mkdirs() }
    val photoFile = File.createTempFile("qr_", ".jpg", imagesDir)

    val output = ImageCapture.OutputFileOptions.Builder(photoFile).build()
    imageCapture.takePicture(
        output,
        ContextCompat.getMainExecutor(this),
        object : ImageCapture.OnImageSavedCallback {
            override fun onImageSaved(result: ImageCapture.OutputFileResults) {
                val uri = FileProvider.getUriForFile(
                    this@QRActivity,
                    "${packageName}.fileprovider",
                    photoFile
                )
                // hand both the VALUE and the PHOTO URI to next page
                val i = Intent(this@QRActivity, SummaryActivity::class.java).apply {
                    putExtra("qr_value", decoded)
                    putExtra("qr_uri", uri.toString())
                    addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                }
                startActivity(i)
            }
            override fun onError(exc: ImageCaptureException) {
                // fallback: open next page without image
                val i = Intent(this@QRActivity, SummaryActivity::class.java)
                    .putExtra("qr_value", decoded)
                startActivity(i)
            }
        }
    )
}





<androidx.constraintlayout.widget.ConstraintLayout
    xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:padding="20dp">

    <ImageView
        android:id="@+id/qrPhoto"
        android:layout_width="0dp"
        android:layout_height="240dp"
        android:scaleType="centerCrop"
        android:adjustViewBounds="true"
        app:layout_constraintTop_toTopOf="parent"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toEndOf="parent" />

    <TextView
        android:id="@+id/qrValue"
        android:layout_width="0dp"
        android:layout_height="wrap_content"
        android:paddingTop="16dp"
        android:textSize="18sp"
        android:textColor="@android:color/white"
        app:layout_constraintTop_toBottomOf="@id/qrPhoto"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toEndOf="parent" />
</androidx.constraintlayout.widget.ConstraintLayout>










<androidx.constraintlayout.widget.ConstraintLayout
    xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:padding="20dp">

    <ImageView
        android:id="@+id/qrPhoto"
        android:layout_width="0dp"
        android:layout_height="240dp"
        android:scaleType="centerCrop"
        android:adjustViewBounds="true"
        app:layout_constraintTop_toTopOf="parent"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toEndOf="parent" />

    <TextView
        android:id="@+id/qrValue"
        android:layout_width="0dp"
        android:layout_height="wrap_content"
        android:paddingTop="16dp"
        android:textSize="18sp"
        android:textColor="@android:color/white"
        app:layout_constraintTop_toBottomOf="@id/qrPhoto"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toEndOf="parent" />
</androidx.constraintlayout.widget.ConstraintLayout>








class SummaryActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_summary)

        val img = findViewById<ImageView>(R.id.qrPhoto)
        val txt = findViewById<TextView>(R.id.qrValue)

        val value = intent.getStringExtra("qr_value").orEmpty()
        val uriStr = intent.getStringExtra("qr_uri")
        txt.text = value

        uriStr?.let { img.setImageURI(Uri.parse(it)) }
    }
}





